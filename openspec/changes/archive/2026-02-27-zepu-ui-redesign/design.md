## 上下文

ZePublish 当前已经具备文章信息、模板套装、插件管理、AI 辅助、封面设计、云存储、预览与复制导出等能力，但这些能力主要以 Toolbar 功能清单方式组织。结果是用户在“创作准备 → 样式校验 → 交付发布”任务链中频繁跨区跳转，交付语义分散（复制入口散落、分发入口未收敛），并且主题与布局能力缺乏统一的可扩展约束。

当前系统约束：
- 运行环境为 Obsidian ItemView + React + Shadow DOM。
- 前端与平台通过 callback API 桥接（`onCopy`、`onDistribute`、`onThemeChange` 等）。
- 现有功能必须保持兼容，不允许因重构导致核心交付能力回退。

## 目标 / 非目标

**目标：**
- 将界面重组为任务导向三工作区：`Prepare`、`Review`、`Deliver`。
- 统一交付语义与状态模型，确保交付链路可观察、可恢复。
- 建立语义化主题令牌体系，统一浅色/深色/跟随系统的一致表现。
- 以渐进方式提供布局灵活性（默认稳定 + 可折叠 + 可记忆）。
- 为旧入口提供过渡路径与回滚策略。

**非目标：**
- 不在本变更中新增外部发布平台或新增业务渠道。
- 不重写 Markdown 渲染引擎与插件处理管线。
- 不一次性引入高度自由拖拽布局（先保证默认可用性）。
- 不在本阶段强制替换全部历史组件样式实现细节。

## 决策

### 决策 1：采用“任务域信息架构”替代“功能平铺导航”
- 选择：顶层导航收敛为 `Prepare / Review / Deliver`，原有 section 作为二级内容映射进入对应任务域。
- 原因：用户目标是完成任务链而非浏览功能目录，任务域能减少上下文切换成本。
- 备选方案：维持原 10+ section 平铺并仅优化视觉样式。
  - 放弃原因：无法从根本上降低路径复杂度。

### 决策 2：交付动作统一为三类语义
- 选择：统一文案与动作域为 `复制`、`导出`、`发布`，并在 Deliver 工作区集中承载。
- 原因：当前交付入口分散导致“可做什么”与“下一步做什么”不清晰。
- 备选方案：保留分散动作，仅增加提示。
  - 放弃原因：无法形成稳定心智模型。

### 决策 3：建立交付状态机作为交互骨架
- 选择：采用 `ReadyToShip / Blocked / Delivering / Failed / Success` 状态机，并在交付区持续展示当前状态、阻断项、下一步建议。
- 原因：交付属于高价值动作，必须具备可观测性和失败恢复路径。
- 备选方案：保持当前按钮触发 + 通知提示模式。
  - 放弃原因：难以追踪失败、难以引导恢复。

### 决策 4：主题系统采用 Token-first，而非组件级散点覆盖
- 选择：定义语义令牌层（`background/surface/text/border/primary/warning/success`）后再映射到组件样式。
- 原因：避免继续积累硬编码色值，提升跨模式一致性与后续扩展性。
- 备选方案：按页面局部重写样式。
  - 放弃原因：维护成本高且易出现视觉回归。

### 决策 5：布局灵活能力分阶段开放
- 选择：先交付稳定默认布局，再开启折叠/记忆，最后评估 Workspace 预设。
- 原因：在 Obsidian 宿主下，布局自由度越高，边界状态和回归风险越大。
- 备选方案：首版即开放自由拖拽布局。
  - 放弃原因：复杂度过高，影响上线稳定性。

## 风险 / 权衡

- [风险] 用户对旧入口存在肌肉记忆，重组后短期找不到操作。
  → 缓解措施：过渡期保留旧入口别名、提供映射提示与一键跳转。

- [风险] 交付状态机与真实执行状态不同步，造成认知冲突。
  → 缓解措施：状态来源收敛为单一数据源，失败态必须附带错误原因与恢复动作。

- [风险] 主题令牌迁移过程中出现对比度或可读性回归。
  → 缓解措施：先建立令牌映射清单与视觉基线，再分模块替换与回归测试。

- [风险] 布局记忆在不同窗口尺寸/侧边栏宽度下失效。
  → 缓解措施：为记忆布局设置约束边界，并提供“恢复默认布局”。

## Migration Plan

1. 完成 IA 重组与映射（不改业务能力，仅改入口组织与主动作位置）。
2. 在 Deliver 区建立统一动作与状态机展示，收敛复制/导出/发布入口。
3. 推进 Token-first 样式迁移，分批替换关键组件样式。
4. 引入折叠与布局记忆，验证 Obsidian 宿主下的稳定性。
5. 过渡期并行保留旧入口提示；稳定后再清理冗余入口。

回滚策略：
- 任一阶段出现高频阻断（交付失败、关键入口不可达、视觉可读性严重下降）时，回滚至上一阶段稳定入口结构。
- 保留旧导航与旧交付入口的兼容开关，支持快速切回。

## Open Questions

- 交付中心中的“发布”在本阶段是否仅作为统一入口，还是同步推进平台级真实发布实现？
- `logs` 是独立工作区资源，还是应拆分为“AI日志”和“交付日志”两条数据源？
- Workspace 预设是否需要按文档类型（技术文、图文、长文）提供默认模板？
- 过渡期应持续几个版本以降低老用户学习成本？
